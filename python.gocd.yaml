pipelines:
  python-build:
    group: Gauge-Python
    materials:
      python:
        git: https://github.com/getgauge/gauge-python.git
    stages:
      - test:
          jobs:
            osx:
              resources:
                - darwin
                - UT
              tasks:
                - exec:
                   command: /bin/sh
                   arguments:
                    - -c
                    - pip3 install -r requirements.txt --user
                - exec:
                   command: /bin/sh
                   arguments:
                    - -c
                    - PATH=$HOME/Library/Python/3.7/bin:$PATH python3 build.py --test
            linux:
              elastic_profile_id: centos-jdk-mvn-python
              tasks:
                - exec:
                   command: pip
                   arguments:
                    - install
                    - -r
                    - requirements.txt
                    - --user
                - exec:
                   command: python
                   arguments:
                    - build.py
                    - --test
            windows:
              elastic_profile_id: windows-all
              tasks:
                - exec:
                   command: pip
                   arguments:
                    - install
                    - -r
                    - requirements.txt
                - exec:
                   command: python
                   arguments:
                    - build.py
                    - --test
  python-package:
    group: Gauge-Python
    materials:
      python:
        git: https://github.com/getgauge/gauge-python.git
      package:
        pipeline: python-build
        stage: test
    stages:
      - package:
          jobs:
            package:
              elastic_profile_id: centos-jdk-mvn-python
              tasks:
                - exec:
                   command: /bin/sh
                   arguments:
                    - -c
                    - rm -rf dist bin
                - exec:
                   command: pip
                   arguments:
                    - install
                    - -r
                    - requirements.txt
                    - --user
                - exec:
                   command: python
                   arguments:
                    - build.py
                    - --dist
              artifacts:
               - build:
                   source: bin/
               - build:
                   source: dist/
  python-FT:
    group: Gauge-Python
    materials:
      gauge-tests:
        git: https://github.com/getgauge/gauge-tests.git
      package:
        pipeline: python-package
        stage: package
      gauge:
        pipeline: Gauge-Build
        stage: windows
      html-report:
        pipeline: HTML_Report
        stage: package
      xml-report:
        pipeline: XML_Report
        stage: package
    environment_variables:
      enable_multithreading: true
    stages:
      - FT:
          clean_workspace: true
          jobs:
            windows:
              elastic_profile_id: windows-all
              environment_variables:
               GAUGE_ROOT: C:\gauge_root
              tasks:
                - fetch:
                    pipeline: Gauge-Build
                    stage: windows
                    job: sign
                    is_file: yes
                    source: test_installers/gauge-windows.x86_64.zip
                - fetch:
                    pipeline: python-package
                    stage: package
                    job: package
                    source: bin
                - fetch:
                    pipeline: python-package
                    stage: package
                    job: package
                    source: dist
                - fetch:
                    pipeline: HTML_Report
                    stage: package
                    job: package
                    source: deploy
                - fetch:
                    pipeline: XML_Report
                    stage: package
                    job: package
                    source: deploy
                - exec:
                    command: cmd
                    arguments:
                      - /c
                      - "unzip -o gauge-windows.x86_64.zip -d %GAUGE_ROOT%"
                - exec:
                    command: cmd
                    arguments:
                      - /c
                      - "%GAUGE_ROOT%/gauge"
                      - uninstall
                      - python
                - exec:
                    command: cmd
                    arguments:
                      - /c
                      - "%GAUGE_ROOT%/gauge"
                      - uninstall
                      - html-report
                - exec:
                    command: cmd
                    arguments:
                      - /c
                      - "%GAUGE_ROOT%/gauge"
                      - uninstall
                      - xml-report
                - exec:
                    working_directory: deploy
                    command: cmd
                    arguments:
                      - /c
                      - "for %f in (html-report-*-windows.x86_64.zip) do %GAUGE_ROOT%/gauge install html-report -f %f"
                - exec:
                    working_directory: deploy
                    command: cmd
                    arguments:
                      - /c
                      - "for %f in (xml-report-*-windows.x86_64.zip) do %GAUGE_ROOT%/gauge install xml-report -f %f"
                - exec:
                    command: cmd
                    arguments:
                      - /c
                      - "%GAUGE_ROOT%/gauge config gauge_repository_url https://raw.githubusercontent.com/getgauge/gauge-nightly-repository/master"
                - exec:
                    command: cmd
                    arguments:
                      - /c
                      - "%GAUGE_ROOT%/gauge install"
                - exec:
                    command: cmd
                    arguments:
                      - /c
                      - "%GAUGE_ROOT%/gauge version"
                - exec:
                    working_directory: bin
                    command: cmd
                    arguments:
                      - /c
                      - "for %f in (gauge-python-*.zip) do %GAUGE_ROOT%/gauge install python -f %f"
                - exec:
                    working_directory: dist
                    command: cmd
                    arguments:
                      - /c
                      - "for %f in (getgauge-*.tar.gz) do pip install %f --upgrade"
                - exec:
                    command: cmd
                    arguments:
                      - /c
                      - path %GAUGE_ROOT%;%PATH% & mvn -q clean test-compile gauge:execute -Denv=ci-python -Dtags=python
              artifacts:
                - build:
                    source: testLogs
                    destination: test-logs
            osx:
              resources:
                - darwin
                - FT
              environment_variables:
                GAUGE_PREFIX: /tmp
                GAUGE_HOME: /tmp
              tasks:
                - fetch:
                    pipeline:  Gauge-Build
                    stage: windows
                    job: sign
                    is_file: yes
                    source: test_installers/gauge-darwin.x86_64.zip
                - fetch:
                    pipeline: HTML_Report
                    stage: package
                    job: package
                    source: deploy
                - fetch:
                    pipeline: XML_Report
                    stage: package
                    job: package
                    source: deploy
                - fetch:
                    pipeline: python-package
                    stage: package
                    job: package
                    source: bin
                - fetch:
                    pipeline: python-package
                    stage: package
                    job: package
                    source: dist
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - mkdir -p $GAUGE_PREFIX/bin
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - unzip -o gauge-darwin.x86_64.zip -d $GAUGE_PREFIX/bin
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - $GAUGE_PREFIX/bin/gauge -v
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - $GAUGE_PREFIX/bin/gauge uninstall python
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - $GAUGE_PREFIX/bin/gauge uninstall html-report
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - $GAUGE_PREFIX/bin/gauge uninstall xml-report
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - $GAUGE_PREFIX/bin/gauge install html-report -f deploy/html-report-*-darwin.x86_64.zip
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - $GAUGE_PREFIX/bin/gauge install xml-report -f deploy/xml-report-*-darwin.x86_64.zip
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - $GAUGE_PREFIX/bin/gauge install python -f bin/gauge-python-*.zip
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - PATH=/tmp/bin:$PATH gauge config gauge_repository_url https://raw.githubusercontent.com/getgauge/gauge-nightly-repository/master
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - ls dist
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - (file=$(ls dist/getgauge-*.tar.gz); pip3 install $file --user --upgrade)
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - PATH=/tmp/bin:$PATH gauge install && PATH=/tmp/bin:$PATH gauge version
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - pip3 list
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - GAUGE_PYTHON_COMMAND=python3 PATH=/tmp/bin:$PATH mvn -q clean install -Denv=ci-python -Dtags="python"
              artifiacts:
                - build:
                    source: testLogs
                    destination: test-logs
            linux:
              elastic_profile_id: centos-jdk-mvn-python
              environment_variables:
                GAUGE_PREFIX: /tmp
                GAUGE_HOME: /tmp
              tasks:
                - fetch:
                    pipeline: Gauge-Build
                    stage: windows
                    job: sign
                    is_file: yes
                    source: test_installers/gauge-linux.x86_64.zip
                - fetch:
                    pipeline: python-package
                    stage: package
                    job: package
                    source: bin
                - fetch:
                    pipeline: python-package
                    stage: package
                    job: package
                    source: dist
                - fetch:
                    pipeline: HTML_Report
                    stage: package
                    job: package
                    source: deploy
                - fetch:
                    pipeline: XML_Report
                    stage: package
                    job: package
                    source: deploy
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - mkdir -p $GAUGE_PREFIX/bin
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - unzip -o gauge-linux.x86_64.zip -d $GAUGE_PREFIX/bin
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - $GAUGE_PREFIX/bin/gauge -v
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - $GAUGE_PREFIX/bin/gauge uninstall python
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - $GAUGE_PREFIX/bin/gauge uninstall html-report
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - $GAUGE_PREFIX/bin/gauge uninstall xml-report
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - $GAUGE_PREFIX/bin/gauge install html-report -f deploy/html-report-*-linux.x86_64.zip
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - $GAUGE_PREFIX/bin/gauge install xml-report -f deploy/xml-report-*-linux.x86_64.zip
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - $GAUGE_PREFIX/bin/gauge install python -f bin/gauge-python-*.zip
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - ls dist
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - (file=$(ls dist/getgauge-*.tar.gz); pip install $file --user --upgrade)
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - PATH=/tmp/bin:$PATH gauge config gauge_repository_url https://raw.githubusercontent.com/getgauge/gauge-nightly-repository/master
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - PATH=/tmp/bin:$PATH gauge install && PATH=/tmp/bin:$PATH gauge version
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - PATH=/tmp/bin:$PATH mvn -q clean install -Denv=ci-python -Dtags="python"
              artifiacts:
                - build:
                    source: testLogs
                    destination: test-logs
  python-lsp-tests:
    group: Gauge-Python
    materials:
      gauge-lsp-tests:
        git: https://github.com/getgauge/gauge-lsp-tests.git
      package:
        pipeline: python-package
        stage: package
      gauge:
        pipeline: Gauge-Build
        stage: windows
    stages:
      - wd:
          cleanWorkingDir: true
          jobs:
            osx:
              resources:
                - darwin
                - FT
              environment_variables:
                GAUGE_PREFIX: /tmp
                GAUGE_HOME: /tmp
              tasks:
                - fetch:
                    pipeline: Gauge-Build
                    stage: windows
                    job: sign
                    is_file: yes
                    source: test_installers/gauge-darwin.x86_64.zip
                - fetch:
                    pipeline: python-package
                    stage: package
                    job: package
                    source: bin
                - fetch:
                    pipeline: python-package
                    stage: package
                    job: package
                    source: dist
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - mkdir -p $GAUGE_PREFIX/bin
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - unzip -o gauge-darwin.x86_64.zip -d $GAUGE_PREFIX/bin
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - PATH=$GAUGE_PREFIX/bin:$PATH gauge version
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - $GAUGE_PREFIX/bin/gauge uninstall python
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - PATH=$GAUGE_PREFIX/bin:$PATH gauge install python -f bin/gauge-python-*.zip
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - ls dist
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - (file=$(ls dist/getgauge-*.tar.gz); pip3 install $file --user --upgrade)
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - PATH=/tmp/bin:$PATH gauge config gauge_repository_url https://raw.githubusercontent.com/getgauge/gauge-nightly-repository/master
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - PATH=/tmp/bin:$PATH gauge uninstall js
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - PATH=/tmp/bin:$PATH gauge install
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - PATH=/tmp/bin:$PATH gauge version
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - pip3 show getgauge
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - npm install
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - GAUGE_PYTHON_COMMAND=python3 PATH=/tmp/bin:$PATH gauge run --env=python-wd --tags='!knownIssue & actions_on_project_load & !actions_on_file_edit'
              artifacts:
                - build:
                    source: logs
                    destination: logs
            linux:
              elastic_profile_id: centos-node-python
              environment_variables:
                GAUGE_PREFIX: /tmp
                GAUGE_HOME: /tmp
              tasks:
                - fetch:
                    pipeline: Gauge-Build
                    stage: windows
                    job: sign
                    is_file: yes
                    source: test_installers/gauge-linux.x86_64.zip
                - fetch:
                    pipeline: python-package
                    stage: package
                    job: package
                    source: bin
                - fetch:
                    pipeline: python-package
                    stage: package
                    job: package
                    source: dist
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - mkdir -p $GAUGE_PREFIX/bin
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - unzip -o gauge-linux.x86_64.zip -d $GAUGE_PREFIX/bin
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - PATH=/tmp/bin:$PATH gauge version
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - PATH=/tmp/bin:$PATH gauge uninstall python
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - PATH=/tmp/bin:$PATH gauge install python -f bin/gauge-python-*.zip
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - ls dist
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - (file=$(ls dist/getgauge-*.tar.gz); pip install $file --user --upgrade)
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - PATH=/tmp/bin:$PATH gauge config gauge_repository_url https://raw.githubusercontent.com/getgauge/gauge-nightly-repository/master
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - PATH=/tmp/bin:$PATH gauge install
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - PATH=/tmp/bin:$PATH gauge version
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - pip show getgauge
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - npm install
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - PATH=/tmp/bin:$PATH gauge run --env=python-wd --tags='!knownIssue & (actions_on_project_load | actions_on_file_edit)'
              artifacts:
                - build:
                    source: logs
                    destination: logs
            windows:
              elastic_profile_id: windows-all
              environment_variables:
                GAUGE_ROOT: C:\gauge_root
                GAUGE_HOME: C:\gauge_plugins
              tasks:
                - fetch:
                    pipeline: Gauge-Build
                    stage: windows
                    job: sign
                    is_file: yes
                    source: test_installers/gauge-windows.x86_64.zip
                - fetch:
                    pipeline: python-package
                    stage: package
                    job: package
                    source: bin
                - fetch:
                    pipeline: python-package
                    stage: package
                    job: package
                    source: dist
                - exec:
                    command: cmd
                    arguments:
                      - /c
                      - "unzip -o gauge-windows.x86_64.zip -d %GAUGE_ROOT%"
                - exec:
                    command: cmd
                    arguments:
                      - /c
                      - "%GAUGE_ROOT%/gauge"
                      - uninstall
                      - python
                - exec:
                    working_directory: bin
                    command: cmd
                    arguments:
                      - /c
                      - "for %f in (gauge-python-*.zip) do %GAUGE_ROOT%/gauge install python -f %f"
                - exec:
                    working_directory: dist
                    command: cmd
                    arguments:
                      - /c
                      - "for %f in (getgauge-*.tar.gz) do pip install %f --upgrade"
                - exec:
                    command: cmd
                    arguments:
                      - /c
                      - "%GAUGE_ROOT%/gauge config gauge_repository_url https://raw.githubusercontent.com/getgauge/gauge-nightly-repository/master"
                - exec:
                    command: cmd
                    arguments:
                      - /c
                      - "%GAUGE_ROOT%/gauge"
                      - uninstall
                      - js
                - exec:
                    command: cmd
                    arguments:
                      - /c
                      - "%GAUGE_ROOT%/gauge install"
                - exec:
                    command: cmd
                    arguments:
                      - /c
                      - "%GAUGE_ROOT%/gauge version"
                - exec:
                    command: cmd
                    arguments:
                      - /c
                      - "pip show getgauge"
                - exec:
                    command: cmd
                    arguments:
                      - /c
                      - npm
                      - install
                - exec:
                    command: powershell.exe
                    arguments:
                      - "./exec_windows_load.ps1 -gauge_env python-wd"
                - exec:
                    run_if: any
                    command: cmd
                    arguments:
                      - /c
                      - del %GAUGE_ROOT%\gauge
                - exec:
                    run_if: any
                    command: cmd
                    arguments:
                      - /c
                      - del /q %GAUGE_HOME%\*
              artifacts:
                - build:
                    source: logs
                    destination: logs
      - no-wd:
          cleanWorkingDir: true
          jobs:
            osx:
              resources:
                - darwin
                - FT
              environment_variables:
                GAUGE_PREFIX: /tmp
                GAUGE_HOME: /tmp
              tasks:
                - fetch:
                    pipeline: Gauge-Build
                    stage: windows
                    job: sign
                    is_file: yes
                    source: test_installers/gauge-darwin.x86_64.zip
                - fetch:
                    pipeline: python-package
                    stage: package
                    job: package
                    source: bin
                - fetch:
                    pipeline: python-package
                    stage: package
                    job: package
                    source: dist
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - mkdir -p $GAUGE_PREFIX/bin
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - unzip -o gauge-darwin.x86_64.zip -d $GAUGE_PREFIX/bin
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - PATH=$GAUGE_PREFIX/bin:$PATH gauge version
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - $GAUGE_PREFIX/bin/gauge uninstall python
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - PATH=$GAUGE_PREFIX/bin:$PATH gauge install python -f bin/gauge-python-*.zip
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - ls dist
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - (file=$(ls dist/getgauge-*.tar.gz); pip3 install $file --user --upgrade)
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - PATH=/tmp/bin:$PATH gauge config gauge_repository_url https://raw.githubusercontent.com/getgauge/gauge-nightly-repository/master
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - PATH=/tmp/bin:$PATH gauge install
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - PATH=/tmp/bin:$PATH gauge version
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - npm install
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - GAUGE_PYTHON_COMMAND=python3 PATH=/tmp/bin:$PATH gauge run --env=python-no-wd --tags='!knownIssue & actions_on_project_load & !actions_on_file_edit'
              artifacts:
                - build:
                    source: logs
                    destination: logs
            linux:
              elastic_profile_id: centos-node-python
              environment_variables:
                GAUGE_PREFIX: /tmp
                GAUGE_HOME: /tmp
              tasks:
                - fetch:
                    pipeline: Gauge-Build
                    stage: windows
                    job: sign
                    is_file: yes
                    source: test_installers/gauge-linux.x86_64.zip
                - fetch:
                    pipeline: python-package
                    stage: package
                    job: package
                    source: bin
                - fetch:
                    pipeline: python-package
                    stage: package
                    job: package
                    source: dist
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - mkdir -p $GAUGE_PREFIX/bin
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - unzip -o gauge-linux.x86_64.zip -d $GAUGE_PREFIX/bin
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - PATH=/tmp/bin:$PATH gauge version
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - PATH=/tmp/bin:$PATH gauge uninstall python
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - PATH=/tmp/bin:$PATH gauge install python -f bin/gauge-python-*.zip
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - ls dist
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - (file=$(ls dist/getgauge-*.tar.gz); pip install $file --user --upgrade)
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - PATH=/tmp/bin:$PATH gauge config gauge_repository_url https://raw.githubusercontent.com/getgauge/gauge-nightly-repository/master
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - PATH=/tmp/bin:$PATH gauge install
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - PATH=/tmp/bin:$PATH gauge version

                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - npm install
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - PATH=/tmp/bin:$PATH gauge run --env=python-no-wd --tags='!knownIssue & (actions_on_project_load | actions_on_file_edit)'
              artifacts:
                - build:
                    source: logs
                    destination: logs
            windows:
              elastic_profile_id: windows-all
              environment_variables:
                GAUGE_ROOT: C:\gauge_root
                GAUGE_HOME: C:\gauge_plugins
              tasks:
                - fetch:
                    pipeline: Gauge-Build
                    stage: windows
                    job: sign
                    is_file: yes
                    source: test_installers/gauge-windows.x86_64.zip
                - fetch:
                    pipeline: python-package
                    stage: package
                    job: package
                    source: bin
                - fetch:
                    pipeline: python-package
                    stage: package
                    job: package
                    source: dist
                - exec:
                    command: cmd
                    arguments:
                      - /c
                      - "unzip -o gauge-windows.x86_64.zip -d %GAUGE_ROOT%"
                - exec:
                    command: cmd
                    arguments:
                      - /c
                      - "%GAUGE_ROOT%/gauge"
                      - uninstall
                      - python
                - exec:
                    working_directory: bin
                    command: cmd
                    arguments:
                      - /c
                      - "for %f in (gauge-python-*.zip) do %GAUGE_ROOT%/gauge install python -f %f"
                - exec:
                    working_directory: dist
                    command: cmd
                    arguments:
                      - /c
                      - "for %f in (getgauge-*.tar.gz) do pip install %f --upgrade"
                - exec:
                    command: cmd
                    arguments:
                      - /c
                      - "%GAUGE_ROOT%/gauge config gauge_repository_url https://raw.githubusercontent.com/getgauge/gauge-nightly-repository/master"
                - exec:
                    command: cmd
                    arguments:
                      - /c
                      - "%GAUGE_ROOT%/gauge"
                      - uninstall
                      - js
                - exec:
                    command: cmd
                    arguments:
                      - /c
                      - "%GAUGE_ROOT%/gauge install"
                - exec:
                    command: cmd
                    arguments:
                      - /c
                      - "%GAUGE_ROOT%/gauge version"
                - exec:
                    command: cmd
                    arguments:
                      - /c
                      - npm
                      - install
                - exec:
                    command: powershell.exe
                    arguments:
                      - "./exec_windows_load.ps1 -gauge_env python-no-wd"
                - exec:
                    run_if: any
                    command: cmd
                    arguments:
                      - /c
                      - del %GAUGE_ROOT%\gauge
                - exec:
                    run_if: any
                    command: cmd
                    arguments:
                      - /c
                      - del /q %GAUGE_HOME%\*
              artifacts:
                - build:
                    source: logs
                    destination: logs
  gauge-python-nightly:
    group: Nightly
    materials:
      python:
        git: https://github.com/getgauge/gauge-python.git
    timer:
      spec: "0 30 5 ? * MON-FRI"
      only_on_changes: yes
    stages:
      - package:
          approval: manual
          jobs:
            package:
              elastic_profile_id: centos-jdk-mvn-python
              environment_variables:
                NIGHTLY: true
              tasks:
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - rm -rf dist bin
                - exec:
                    command: pip
                    arguments:
                      - install
                      - -r
                      - requirements.txt
                      - --user
                - exec:
                    command: python
                    arguments:
                      - build.py
                      - --dist
              artifacts:
                - build:
                    source: bin/
                - build:
                    source: dist/
      - upload:
          jobs:
            pypi_upload:
              elastic_profile_id: centos-jdk-mvn-python
              environment_variables:
                NIGHTLY: true
              secure_variables:
                PYPI_USER: AES:LARhFRJy0ctn3K3OUae0OQ==:VO+QaZe34UTgs7gaQatN1w==
                PYPI_PASSWORD: AES:ZEf+/roxrD0DR6pA42VI6Q==:8T8oQb3xcNN+yBQiwgbxWIMEJ6EsU33VoE0s9S2IDWE=
              tasks:
                - fetch:
                    pipeline: gauge-python-nightly
                    stage: package
                    job: package
                    source: dist
                - exec:
                    command: pip
                    arguments:
                      - install
                      - twine
                      - --user
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - (file=$(ls dist/getgauge-*.dev.*.tar.gz);python -m twine upload -u $PYPI_USER -p $PYPI_PASSWORD $file)
            bintray_upload:
              elastic_profile_id: centos-all
              environment_variables:
                UPDATE_INSTALL_JSON: 1
                INSTALL_PLUGIN_JSON: python
                PACKAGE: gauge-python
                PACKAGE_TYPE: nightly
                RENAME: 1
                NOPLATFORM: 1
              secure_variables:
                BINTRAY_USER: AES:khuxGHjHryC+c6inG1sOEw==:foru/1KYzJVuW7wWVgOnnA==
                BINTRAY_API_KEY: AES:rM1zuFCCwUrLgHEx4T7REA==:IxmC+vYVYToes++Tz+RiVotPMVtajbImds2LpwB3lbUqX92IR8fW1WwQ/jH2JrP8
                GITHUB_SSH_PRIVATE_KEY: AES:WufQ+0lOQDuPb9Zf65Liqg==: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
              tasks:
                - fetch:
                    pipeline: gauge-python-nightly
                    stage: package
                    job: package
                    source: bin
                - exec:
                    command: /bin/sh
                    working_directory: bin
                    arguments:
                      - -c
                      - (curl -sSfL https://github.com/getgauge/gauge/raw/master/build/publish_nightly_to_bintray.sh  | sh)
  python-release:
    group: Gauge-Python
    materials:
      package:
        pipeline: python-package
        stage: package
    stages:
      - github:
          approval: manual
          jobs:
            release:
              elastic_profile_id: centos-all
              environment_variables:
                repoName: gauge-python
                GOPATH: /tmp
              secure_variables:
                GITHUB_TOKEN: AES:At7ff8Eq1+fj7MCq6YSI9w==:m6WHp7Ef6WHQwvXNexkmmsIMrHmHGdZZCfF+AqcgwtotEO1GhOsVLSbtzpNrL6Us
              tasks:
                - fetch:
                    pipeline: python-package
                    stage: package
                    job: package
                    source: bin
                - exec:
                   command: /bin/sh
                   working_directory: bin
                   arguments:
                    - -c
                    - (curl -sSfL https://github.com/getgauge/gauge/raw/master/build/github_release.sh | sh)
      - pypi:
          approval: manual
          jobs:
            pypi_upload:
              elastic_profile_id: centos-jdk-mvn-python
              secure_variables:
               PYPI_USER: AES:LARhFRJy0ctn3K3OUae0OQ==:VO+QaZe34UTgs7gaQatN1w==
               PYPI_PASSWORD: AES:ZEf+/roxrD0DR6pA42VI6Q==:8T8oQb3xcNN+yBQiwgbxWIMEJ6EsU33VoE0s9S2IDWE=
              tasks:
               - fetch:
                  pipeline: python-package
                  stage: package
                  job: package
                  source: dist
               - exec:
                  command: pip
                  arguments:
                    - install
                    - twine
                    - --user
               - exec:
                   command: /bin/sh
                   arguments:
                    - -c
                    - (file=$(ls dist/getgauge-*.tar.gz); python -m twine upload -u $PYPI_USER -p $PYPI_PASSWORD $file)

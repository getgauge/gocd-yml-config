pipelines:
  python-build:
    group: Gauge-Python
    materials:
      python:
        git: https://github.com/getgauge/gauge-python.git
    stages:
      - test:
          jobs:
            linux:
              elastic_profile_id: centos-jdk-mvn-python
              tasks:
                - exec:
                   command: pip
                   arguments:
                    - install
                    - -r
                    - requirements.txt
                    - --user
                - exec:
                   command: python
                   arguments:
                    - build.py
                    - --test
            windows:
              elastic_profile_id: windows-all
              tasks:
                - exec:
                   command: pip
                   arguments:
                    - install
                    - -r
                    - requirements.txt
                - exec:
                   command: python
                   arguments:
                    - build.py
                    - --test
  python-package:
    group: Gauge-Python
    materials:
      python:
        git: https://github.com/getgauge/gauge-python.git
      package:
        pipeline: python-build
        stage: test
    stages:
      - package:
          jobs:
            package:
              elastic_profile_id: centos-jdk-mvn-python
              tasks:
                - exec:
                   command: /bin/sh
                   arguments:
                    - -c
                    - rm -rf dist bin
                - exec:
                   command: pip
                   arguments:
                    - install
                    - -r
                    - requirements.txt
                    - --user
                - exec:
                   command: python
                   arguments:
                    - build.py
                    - --dist
              artifacts:
               - build:
                   source: bin/
               - build:
                   source: dist/
  python-FT:
    group: Gauge-Python
    materials:
      gauge-tests:
        git: https://github.com/getgauge/gauge-tests.git
      package:
        pipeline: python-package
        stage: package
      gauge:
        pipeline: Gauge-Build
        stage: windows
      html-report:
        pipeline: HTML_Report
        stage: package
      xml-report:
        pipeline: XML_Report
        stage: package
    environment_variables:
      enable_multithreading: true
    stages:
      - FT:
          clean_workspace: true
          jobs:
            windows:
              elastic_profile_id: windows-all
              environment_variables:
               GAUGE_ROOT: C:\gauge_root
              tasks:
                - fetch:
                    pipeline: Gauge-Build
                    stage: windows
                    job: sign
                    is_file: yes
                    source: test_installers/gauge-windows.x86_64.zip
                - fetch:
                    pipeline: python-package
                    stage: package
                    job: package
                    source: bin
                - fetch:
                    pipeline: python-package
                    stage: package
                    job: package
                    source: dist
                - fetch:
                    pipeline: HTML_Report
                    stage: package
                    job: package
                    source: deploy
                - fetch:
                    pipeline: XML_Report
                    stage: package
                    job: package
                    source: deploy
                - exec:
                    command: cmd
                    arguments:
                      - /c
                      - "unzip -o gauge-windows.x86_64.zip -d %GAUGE_ROOT%"
                - exec:
                    command: cmd
                    arguments:
                      - /c
                      - "%GAUGE_ROOT%/gauge"
                      - uninstall
                      - python
                - exec:
                    command: cmd
                    arguments:
                      - /c
                      - "%GAUGE_ROOT%/gauge"
                      - uninstall
                      - html-report
                - exec:
                    command: cmd
                    arguments:
                      - /c
                      - "%GAUGE_ROOT%/gauge"
                      - uninstall
                      - xml-report
                - exec:
                    working_directory: deploy
                    command: cmd
                    arguments:
                      - /c
                      - "for %f in (html-report-*-windows.x86_64.zip) do %GAUGE_ROOT%/gauge install html-report -f %f"
                - exec:
                    working_directory: deploy
                    command: cmd
                    arguments:
                      - /c
                      - "for %f in (xml-report-*-windows.x86_64.zip) do %GAUGE_ROOT%/gauge install xml-report -f %f"
                - exec:
                    command: cmd
                    arguments:
                      - /c
                      - "%GAUGE_ROOT%/gauge config gauge_repository_url https://raw.githubusercontent.com/getgauge/gauge-nightly-repository/master"
                - exec:
                    command: cmd
                    arguments:
                      - /c
                      - "%GAUGE_ROOT%/gauge install"
                - exec:
                    command: cmd
                    arguments:
                      - /c
                      - "%GAUGE_ROOT%/gauge version"
                - exec:
                    working_directory: bin
                    command: cmd
                    arguments:
                      - /c
                      - "for %f in (gauge-python-*.zip) do %GAUGE_ROOT%/gauge install python -f %f"
                - exec:
                    working_directory: dist
                    command: cmd
                    arguments:
                      - /c
                      - "for %f in (getgauge-*.tar.gz) do pip install %f --upgrade"
                - exec:
                    command: cmd
                    arguments:
                      - /c
                      - path %GAUGE_ROOT%;%PATH% & gradlew.bat clean pythonFT
              artifacts:
                - build:
                    source: testLogs
                    destination: test-logs
            linux:
              elastic_profile_id: centos-jdk-mvn-python
              environment_variables:
                GAUGE_PREFIX: /tmp
                GAUGE_HOME: /tmp
              tasks:
                - fetch:
                    pipeline: Gauge-Build
                    stage: windows
                    job: sign
                    is_file: yes
                    source: test_installers/gauge-linux.x86_64.zip
                - fetch:
                    pipeline: python-package
                    stage: package
                    job: package
                    source: bin
                - fetch:
                    pipeline: python-package
                    stage: package
                    job: package
                    source: dist
                - fetch:
                    pipeline: HTML_Report
                    stage: package
                    job: package
                    source: deploy
                - fetch:
                    pipeline: XML_Report
                    stage: package
                    job: package
                    source: deploy
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - mkdir -p $GAUGE_PREFIX/bin
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - unzip -o gauge-linux.x86_64.zip -d $GAUGE_PREFIX/bin
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - $GAUGE_PREFIX/bin/gauge -v
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - $GAUGE_PREFIX/bin/gauge uninstall python
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - $GAUGE_PREFIX/bin/gauge uninstall html-report
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - $GAUGE_PREFIX/bin/gauge uninstall xml-report
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - $GAUGE_PREFIX/bin/gauge install html-report -f deploy/html-report-*-linux.x86_64.zip
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - $GAUGE_PREFIX/bin/gauge install xml-report -f deploy/xml-report-*-linux.x86_64.zip
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - $GAUGE_PREFIX/bin/gauge install python -f bin/gauge-python-*.zip
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - ls dist
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - (file=$(ls dist/getgauge-*.tar.gz); pip install $file --user --upgrade)
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - PATH=/tmp/bin:$PATH gauge config gauge_repository_url https://raw.githubusercontent.com/getgauge/gauge-nightly-repository/master
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - PATH=/tmp/bin:$PATH gauge install && PATH=/tmp/bin:$PATH gauge version
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - PATH=/tmp/bin:$PATH ./gradlew clean pythonFT
              artifiacts:
                - build:
                    source: testLogs
                    destination: test-logs
  python-lsp-tests:
    group: Gauge-Python
    materials:
      gauge-lsp-tests:
        git: https://github.com/getgauge/gauge-lsp-tests.git
      package:
        pipeline: python-package
        stage: package
      gauge:
        pipeline: Gauge-Build
        stage: windows
    stages:
      - wd:
          cleanWorkingDir: true
          jobs:
            linux:
              elastic_profile_id: centos-node-python
              environment_variables:
                GAUGE_PREFIX: /tmp
                GAUGE_HOME: /tmp
              tasks:
                - fetch:
                    pipeline: Gauge-Build
                    stage: windows
                    job: sign
                    is_file: yes
                    source: test_installers/gauge-linux.x86_64.zip
                - fetch:
                    pipeline: python-package
                    stage: package
                    job: package
                    source: bin
                - fetch:
                    pipeline: python-package
                    stage: package
                    job: package
                    source: dist
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - mkdir -p $GAUGE_PREFIX/bin
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - unzip -o gauge-linux.x86_64.zip -d $GAUGE_PREFIX/bin
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - PATH=/tmp/bin:$PATH gauge version
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - PATH=/tmp/bin:$PATH gauge uninstall python
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - PATH=/tmp/bin:$PATH gauge install python -f bin/gauge-python-*.zip
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - ls dist
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - (file=$(ls dist/getgauge-*.tar.gz); pip install $file --user --upgrade)
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - PATH=/tmp/bin:$PATH gauge config gauge_repository_url https://raw.githubusercontent.com/getgauge/gauge-nightly-repository/master
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - PATH=/tmp/bin:$PATH gauge install
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - PATH=/tmp/bin:$PATH gauge version
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - pip show getgauge
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - npm install
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - PATH=/tmp/bin:$PATH gauge run -v --env=python-wd --tags='!knownIssue & (actions_on_project_load | actions_on_file_edit)'
              artifacts:
                - build:
                    source: logs
                    destination: logs
            windows:
              elastic_profile_id: windows-all
              environment_variables:
                GAUGE_ROOT: C:\gauge_root
                GAUGE_HOME: C:\gauge_plugins
              tasks:
                - fetch:
                    pipeline: Gauge-Build
                    stage: windows
                    job: sign
                    is_file: yes
                    source: test_installers/gauge-windows.x86_64.zip
                - fetch:
                    pipeline: python-package
                    stage: package
                    job: package
                    source: bin
                - fetch:
                    pipeline: python-package
                    stage: package
                    job: package
                    source: dist
                - exec:
                    command: cmd
                    arguments:
                      - /c
                      - "unzip -o gauge-windows.x86_64.zip -d %GAUGE_ROOT%"
                - exec:
                    command: cmd
                    arguments:
                      - /c
                      - "%GAUGE_ROOT%/gauge"
                      - uninstall
                      - python
                - exec:
                    working_directory: bin
                    command: cmd
                    arguments:
                      - /c
                      - "for %f in (gauge-python-*.zip) do %GAUGE_ROOT%/gauge install python -f %f"
                - exec:
                    working_directory: dist
                    command: cmd
                    arguments:
                      - /c
                      - "for %f in (getgauge-*.tar.gz) do pip install %f --upgrade"
                - exec:
                    command: cmd
                    arguments:
                      - /c
                      - "%GAUGE_ROOT%/gauge config gauge_repository_url https://raw.githubusercontent.com/getgauge/gauge-nightly-repository/master"
                - exec:
                    command: cmd
                    arguments:
                      - /c
                      - "%GAUGE_ROOT%/gauge"
                      - uninstall
                      - js
                - exec:
                    command: cmd
                    arguments:
                      - /c
                      - "%GAUGE_ROOT%/gauge install"
                - exec:
                    command: cmd
                    arguments:
                      - /c
                      - "%GAUGE_ROOT%/gauge version"
                - exec:
                    command: cmd
                    arguments:
                      - /c
                      - "pip show getgauge"
                - exec:
                    command: nvm
                    arguments:
                      - install
                      - 10
                - exec:
                    command: nvm
                    arguments:
                      - use
                      - 10
                - exec:
                    command: nvm
                    arguments:
                      - on
                - exec:
                    command: cmd
                    arguments:
                      - /c
                      - npm
                      - install
                - exec:
                    command: powershell.exe
                    arguments:
                      - "./exec_windows_load.ps1 -gauge_env python-wd"
                - exec:
                    run_if: any
                    command: cmd
                    arguments:
                      - /c
                      - del %GAUGE_ROOT%\gauge
                - exec:
                    run_if: any
                    command: cmd
                    arguments:
                      - /c
                      - del /q %GAUGE_HOME%\*
              artifacts:
                - build:
                    source: logs
                    destination: logs
      - no-wd:
          cleanWorkingDir: true
          jobs:
            linux:
              elastic_profile_id: centos-node-python
              environment_variables:
                GAUGE_PREFIX: /tmp
                GAUGE_HOME: /tmp
              tasks:
                - fetch:
                    pipeline: Gauge-Build
                    stage: windows
                    job: sign
                    is_file: yes
                    source: test_installers/gauge-linux.x86_64.zip
                - fetch:
                    pipeline: python-package
                    stage: package
                    job: package
                    source: bin
                - fetch:
                    pipeline: python-package
                    stage: package
                    job: package
                    source: dist
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - mkdir -p $GAUGE_PREFIX/bin
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - unzip -o gauge-linux.x86_64.zip -d $GAUGE_PREFIX/bin
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - PATH=/tmp/bin:$PATH gauge version
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - PATH=/tmp/bin:$PATH gauge uninstall python
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - PATH=/tmp/bin:$PATH gauge install python -f bin/gauge-python-*.zip
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - ls dist
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - (file=$(ls dist/getgauge-*.tar.gz); pip install $file --user --upgrade)
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - PATH=/tmp/bin:$PATH gauge config gauge_repository_url https://raw.githubusercontent.com/getgauge/gauge-nightly-repository/master
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - PATH=/tmp/bin:$PATH gauge install
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - PATH=/tmp/bin:$PATH gauge version

                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - npm install
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - PATH=/tmp/bin:$PATH gauge run --env=python-no-wd --tags='!knownIssue & (actions_on_project_load | actions_on_file_edit)'
              artifacts:
                - build:
                    source: logs
                    destination: logs
            windows:
              elastic_profile_id: windows-all
              environment_variables:
                GAUGE_ROOT: C:\gauge_root
                GAUGE_HOME: C:\gauge_plugins
              tasks:
                - fetch:
                    pipeline: Gauge-Build
                    stage: windows
                    job: sign
                    is_file: yes
                    source: test_installers/gauge-windows.x86_64.zip
                - fetch:
                    pipeline: python-package
                    stage: package
                    job: package
                    source: bin
                - fetch:
                    pipeline: python-package
                    stage: package
                    job: package
                    source: dist
                - exec:
                    command: cmd
                    arguments:
                      - /c
                      - "unzip -o gauge-windows.x86_64.zip -d %GAUGE_ROOT%"
                - exec:
                    command: cmd
                    arguments:
                      - /c
                      - "%GAUGE_ROOT%/gauge"
                      - uninstall
                      - python
                - exec:
                    working_directory: bin
                    command: cmd
                    arguments:
                      - /c
                      - "for %f in (gauge-python-*.zip) do %GAUGE_ROOT%/gauge install python -f %f"
                - exec:
                    working_directory: dist
                    command: cmd
                    arguments:
                      - /c
                      - "for %f in (getgauge-*.tar.gz) do pip install %f --upgrade"
                - exec:
                    command: cmd
                    arguments:
                      - /c
                      - "%GAUGE_ROOT%/gauge config gauge_repository_url https://raw.githubusercontent.com/getgauge/gauge-nightly-repository/master"
                - exec:
                    command: cmd
                    arguments:
                      - /c
                      - "%GAUGE_ROOT%/gauge"
                      - uninstall
                      - js
                - exec:
                    command: cmd
                    arguments:
                      - /c
                      - "%GAUGE_ROOT%/gauge install"
                - exec:
                    command: cmd
                    arguments:
                      - /c
                      - "%GAUGE_ROOT%/gauge version"
                - exec:
                    command: nvm
                    arguments:
                      - install
                      - 10
                - exec:
                    command: nvm
                    arguments:
                      - use
                      - 10
                - exec:
                    command: nvm
                    arguments:
                      - on
                - exec:
                    command: cmd
                    arguments:
                      - /c
                      - npm
                      - install
                - exec:
                    command: powershell.exe
                    arguments:
                      - "./exec_windows_load.ps1 -gauge_env python-no-wd"
                - exec:
                    run_if: any
                    command: cmd
                    arguments:
                      - /c
                      - del %GAUGE_ROOT%\gauge
                - exec:
                    run_if: any
                    command: cmd
                    arguments:
                      - /c
                      - del /q %GAUGE_HOME%\*
              artifacts:
                - build:
                    source: logs
                    destination: logs
  python-release:
    group: Gauge-Python
    materials:
      package:
        pipeline: python-package
        stage: package
    stages:
      - github:
          approval: manual
          jobs:
            release:
              elastic_profile_id: centos-all
              environment_variables:
                repoName: gauge-python
                GOPATH: /tmp
              secure_variables:
                GITHUB_TOKEN: AES:At7ff8Eq1+fj7MCq6YSI9w==:m6WHp7Ef6WHQwvXNexkmmsIMrHmHGdZZCfF+AqcgwtotEO1GhOsVLSbtzpNrL6Us
              tasks:
                - fetch:
                    pipeline: python-package
                    stage: package
                    job: package
                    source: bin
                - exec:
                   command: /bin/sh
                   working_directory: bin
                   arguments:
                    - -c
                    - (curl -sSfL https://github.com/getgauge/gauge/raw/master/build/github_release.sh | sh)
      - pypi:
          approval: manual
          jobs:
            pypi_upload:
              elastic_profile_id: centos-jdk-mvn-python
              secure_variables:
               PYPI_USER: AES:LARhFRJy0ctn3K3OUae0OQ==:VO+QaZe34UTgs7gaQatN1w==
               PYPI_PASSWORD: AES:ZEf+/roxrD0DR6pA42VI6Q==:8T8oQb3xcNN+yBQiwgbxWIMEJ6EsU33VoE0s9S2IDWE=
              tasks:
               - fetch:
                  pipeline: python-package
                  stage: package
                  job: package
                  source: dist
               - exec:
                  command: pip
                  arguments:
                    - install
                    - twine
                    - --user
               - exec:
                   command: /bin/sh
                   arguments:
                    - -c
                    - (file=$(ls dist/getgauge-*.tar.gz); python -m twine upload -u $PYPI_USER -p $PYPI_PASSWORD $file)
